\documentclass[12pt]{article}

\usepackage{amssymb,amsmath,amsfonts,bbm,eurosym,geometry,ulem,graphicx,caption,color,setspace,sectsty,comment,footmisc,caption,natbib,pdflscape,subfigure,array,hyperref, booktabs, tabularx}

\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{babel}
\usepackage[font=small,labelfont={bf,sf},tableposition=top]{caption}

\normalem

\onehalfspacing
\newtheorem{theorem}{Theorem}
\newtheorem{corollary}[theorem]{Corollary}
\newtheorem{proposition}{Proposition}
\newenvironment{proof}[1][Proof]{\noindent\textbf{#1.} }{\ \rule{0.5em}{0.5em}}

\newtheorem{hyp}{Hypothesis}
\newtheorem{subhyp}{Hypothesis}[hyp]
\renewcommand{\thesubhyp}{\thehyp\alph{subhyp}}

\DeclareMathOperator\erfc{erfc}

\newcommand{\red}[1]{{\color{red} #1}}
\newcommand{\blue}[1]{{\color{blue} #1}}

\newcolumntype{L}[1]{>{\raggedright\let\newline\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\arraybackslash\hspace{0pt}}m{#1}}

\geometry{left=1.0in,right=1.0in,top=1.0in,bottom=1.0in}

\begin{document}

\begin{titlepage}
\title{Margin loans with pooled default insurance}
\author{Joseph Clark\thanks{RMIT Blockchain Innovation Hub} }
\date{\today}
\maketitle
\begin{abstract}
\noindent We define a class of margin positions encompassing several commonly used structures for collateral loans and margin accounts and examine the impact of pooling insurance for collateral defaults. The default risk from an individual loan can be priced as a series of forward starting options with a knockout. Under geometric Brownian motion this has an explicit solution. 

%\vspace{0in}\\
%\noindent\textbf{Keywords:} key1, key2, key3\\
%\vspace{0in}\\
%\noindent\textbf{JEL Codes:} key1, key2, key3\\

\bigskip
\end{abstract}
\setcounter{page}{0}
\thispagestyle{empty}
\end{titlepage}
\pagebreak \newpage




\doublespacing


\section{Introduction} \label{sec:introduction}

A margin loan is a portfolio of collateral assets maintained above some (possibly changing) value. If the liquidation value of the collateral assets falls below this value the position is liquidated. If it falls so far that the liquidation value does not cover the loan the position is insolvent. Here we are interested in the difference between the liquidation value and the value of the loan if the position becomes insolvent. In particular we look at the distribution of the sum of defaults to evaluate the effect of capital pools to insure default risk on a set of loans on the same asset taken at different times.



\section{Preliminaries}

For the most part, we follow the notation of \cite{ang20} who analyse Uniswap markets.

\textbf{Definition 1: Margin position}

%[Add collateral asset vs liability value:
%- Special case where one collateral asset vs loan asset (normal CDP, stablecoin mint)
%- More general case where value of pool is dependent on linear assets (futures margin), or maximum loss (e.g. for spreads)
%]

The state of a margin position is a tuple $(t, m(t), M_I, M_V, R_\beta, R_\alpha, D_T, T)$. The observed reference price at time $t$ is $m^r(t)$ for units of $\beta$ per unit of $\alpha$, $M_I$ and $M_V$ are the initial and variation margin, $R_\beta, R_\alpha$ are the reserves held in the margin position, and $D_T$ is discount rate for the margin position maturing at $T$. Note that if $R_\alpha<0$ the margin position has minted these units.

At time $t$ a deposit $\Delta_\beta$  will generate a release 

\begin{equation} \label{Delta_alpha}
\Delta_\alpha = \frac{D_T \Delta_\beta}{m(t) M_I }
\end{equation}


Reserves are updated according to $R_\beta \mapsto R_\beta + \Delta_\beta$, $R_\alpha \mapsto R_\alpha - \Delta_\alpha$. 

At any subsequent time before $T$ if the liquidation value of the collateral $R_\beta/m(t)$ falls below the collateral requirement $M_V R_\alpha$, the position is liquidated into units of $\alpha$, which are retained up to $R_\alpha/D_T$ and the remainder released to the depositor.   

\textbf{Definition 2: Spot market}

A spot market is a mechanism which exchanges $\Delta_\alpha$ units of $\alpha$ for $m^p(t)\Delta_\beta$ units of $\beta$ at time $t$. An infinitely elastic spot market is one where $m^p(t)$ does is not depend on $\Delta_\beta$

We consider a market which updates according to 

\[ m(t+1) = m(t)\exp( \sigma X + \mu) \]

Where $X \sim N(0,1)), \sigma \geq 0$, and  $\mu \in \mathbf{R}$

\section{The distribution of collateral defaults}

We are interested in the distribution of defaults on the margin loan given some spot market process. A margin event occurs if the liquidation value of the collateral falls below the variation margin:

\begin{equation} \label{IM}
    I_M(t) = \mathbbm{1} \left( L(t) \equiv \frac{R_\beta}{m(t)} < \frac{R_\alpha}{D_T} M_V \equiv V(t) \right)
\end{equation}

Since a loan can only default once we need an indicator for whether the loan has value has been below the variation margin in a previous period

\begin{equation} \label{IL}
    I_L(t) = 1-\prod_{\tau=1}^{t-1} \left(1-I_M(\tau) \right)
\end{equation}

A default event occurs if the liquidation value of the collateral is below the value of the loan

\begin{equation} \label{ID}
    I_D(t) = \mathbbm{1} \left( L(t) \equiv \frac{R_\beta}{m(t)} < \frac{R_\alpha}{D_T}  \equiv C_\alpha(t)\right)
\end{equation}

The value of a default is then

\begin{equation}
    I_D(t) ( R_\alpha / D_T - L(t))
\end{equation}


[Figure for L(t) with variation and default lines.]

\section{Replication}

The arrangement between the borrower and the lender can be represented as call and put options between each observation period\footnote{That is, between periods where the margin loan has the opportunity to to liquidate collateral.}. From the lender's perspective the arrangement is a short put with a strike equal to the value liability of the loan: $R_\alpha/D_T$. For any liquidation value of the collateral below this, the lender loses one unit of $\alpha$ per unit of deficit. In the case where it is not possible for the lender to repay the loan early this sequence of forward staring options is a type of cliquet with a knockout barrier at the variance margin. The total premium for this option is the discount rate expressed as units of $\alpha$:

\[ {(1-D_T) R_\alpha \]

%\subsection{Replication of pooled insurance}

%An insurance pool guaranteeing defaults from a collection of loans can also be seen as a basket option on these cliques. 


\section{Simulation}

We construct a simulation of a margin loan pool that releases one loan in each of the first $H$ periods that all expire at $H+T$. For each period after the inception of the loan we construct the default and margin call indicators $I_D$ and $I_M$. Without losing much generality we assume $D_T, R_\beta = 1$

We start by simulating a realization of 

\[\left(m^{(s)}(\tau)\right)_{\tau=1}^{H+T}\]

For the first $H$ periods the $\frac{1}{m^{(s)}(t) M_I}$ units of $\alpha$  are lent (from \ref{Delta_alpha}). For $t=1$ to $H+T$ calculate 

     \[ I_M(t) = \mathbbm{1}\left( \frac{1}{m^{(s)}(t)}< R_\alpha^{i} M_V \right) \]
     \[ I_L(t) = 1-\prod_{\tau=1}^{t-1} \left(1-I_M(\tau) \right)\]
     \[ I_D(t) = \mathbbm{1} \left( \frac{1}{m^{(s)}(t)} < R_\alpha^{i} \right) \]

The average amount of defaults as a fraction of loaned value across simulations is

\begin{equation} \label{EDefaultSim}
     \frac{\sum_{s=1}^S \sum_{i=1}^H \sum_{\tau=t}^{T}  \left(R_\alpha^i - \frac{1}{m^{(s)}(\tau)} \right) I_D(t) (1-I_L(t))}{HS R_\alpha^i} 
\end{equation}

Tables \ref{tab:defaultCost1} and \ref{tab:defaultCost2} simulate annual default costs for three maturities of loans if the the market rate follows geometric Brownian motion with different levels of volatility.

% Constructor: default_simulation.py

   \begin{table}[!ht]
     \caption{Annual default cost: $M_I$ = 1.5, $M_V$ = 1.2, Observation period each 1 minute, $H=0$ }\label{tab:defaultCost1}
     \centering
     \begin{tabularx}{\linewidth}{Xcccc}\toprule
       $\sigma$ (annualized) & One day loan  & Seven day loan & On month loan\\ \midrule
       
       3000\% & 0 & 0.00\% & 0.00\%   \\
       3500\% & 0.01\% & 0.00\% & 0.00\%   \\
       4000\% & 0.08\% & 0.01\% & 0.00\%   \\ 
       4500\% & 0.30\% & 0.03\% & 0.01\%   \\
       5000\% & 1.08\% & 0.18\% & 0.03\%   \\
       5500\% & 3.04\% & 0.42\% & 0.11\%   \\ 
       \addlinespace
     \end{tabularx}

   \end{table}


   \begin{table}[!ht]
     \caption{Annual default cost: $M_I$ = 1.5, $M_V$ = 1.15, Observation period each 1 minute, $H=0$}\label{tab:defaultCost2}
     \centering
     \begin{tabularx}{\linewidth}{Xcccc}\toprule
       $\sigma$ (annualized) & One day loan  & Seven day loan & On month loan\\ \midrule
       
       3000\% & 0.02\% & 0.01\% & 0.00\%   \\
       3500\% & 0.51\% & 0.02\% & 0.00\%   \\
       4000\% & 1.61\% & 0.10\% & 0.06\%   \\ 
       4500\% & 3.32\% & 0.53\% & 0.14\%   \\
       5000\% & 7.83\% & 1.21\% & 0.29\%   \\
       5500\% & 16.22\% & 2.19\% & 0.54\%   \\ 
       \addlinespace
     \end{tabularx}

   \end{table}



\singlespacing
\setlength\bibsep{0pt}
\bibliographystyle{my-style}
\bibliography{Placeholder}



\clearpage

\onehalfspacing

%\section*{Tables} \label{sec:tab}
%\addcontentsline{toc}{section}{Tables}



%\clearpage

%\section*{Figures} \label{sec:fig}
%\addcontentsline{toc}{section}{Figures}

%\begin{figure}[hp]
%  \centering
%  \includegraphics[width=.6\textwidth]{../fig/placeholder.pdf}
%  \caption{Placeholder}
%  \label{fig:placeholder}
%\end{figure}




\clearpage

\section*{Appendix A. An analytic result for expected defaults} \label{sec:appendixa}
\addcontentsline{toc}{section}{Appendix A: }

If the market price is Geometric Brownian Motion the expected value of defaults can be constructed straightforwardly. For a particular liquidation value $L(t) = \bar{L} > M_V R_\alpha$ the expected value of a default after $\Delta t$ is 

\[ \int_0^{R_\alpha} (R_\alpha - L) f_L}(L, \Delta t, \bar{L}) dL \]

Assuming no drift the density after $\Delta t$ is

\[ f_L(L, \Delta t, \bar{L})  = \frac{1}{\sqrt{2\pi}} \frac{1}{L \sigma \sqrt{\Delta t}} \exp \frac{-(\log(L/\bar{L}) + 0.5 \sigma^2 \Delta t)^2 }{2\sigma^2 \Delta t}\]

Similarly, the density of the price at any point is

\[ f_L(L,t, L(0)) = \frac{1}{\sqrt{2\pi}} \frac{1}{L \sigma \sqrt{t}} \exp \frac{-(\log(L/L(0)) + 0.5 \sigma^2 t)^2 }{2\sigma^2 t} \]

Finally, we need to adjust for the probability that the position has already been liquidated at point $t$ given the current liquidation value. By symmetry this is twice the probability that the liquidation value will have increased by at least the difference between the current liquidation value and the variation margin. 

\[ P(Liquidated | L = \bar{L}) = 2 P(L(t)> 2 \bar{L} - R_\alpha M_V) | L(0)=\bar{L}  ) = 2 N(d_2(\bar{L}, 2\bar{L} - R_\alpha M_V})) \]

Using the Black-Scholes-Merton $d_2$ (see \cite{BS73}, \cite{Merton73}})

\[d_2(\bar{L}, 2\bar{L} - R_\alpha M_V,t) =  \frac{ \frac{\bar{L}}{2\bar{L} - R_\alpha M_V} - 0.5 \sigma^2 t}{\sigma \sqrt{t}} \]

The total expected default is then

\begin{equation} \label{EDefaultGBM}
\int_0^T \left( \int_{R_\alpha M_V}^\infty \left( \int_0^{R_\alpha} (R_\alpha - L) f_L}(L, \Delta t, \bar{L}) dL \right) f(\bar{L},t,L(0)) (1-P(Liquidated | L = \bar{L}) ) d\bar{L}  \right) dt   
\end{equation}

Numerically integrating a discretized version of \ref{EDefaultGBM} over a distribution of $R_\alpha$ is faster than simulating with \ref{EDefaultSim}.


% Note: This is a standard barrier result using reflection and strong markov property but not it doesn't seem to work exactly in sims. What to do?
% Jupyter notebook: MarginsWithPooledInsurance.ipynb



% Extensions:
% Other processes?
% Attack where to manipulate price downwards so that the MP liquidates the collateral too cheaply.


\begin{thebibliography}{}
\bibitem{ang20} Angeris, Guillermo, Hsien-Tang Kao, Rei Chiang, Charlie Noyes, and Tarun Chitra  \textit{An analysis of Uniswap markets}, arXiv preprint arXiv:1911.03380, 2020.

\bibitem{Zha18} Zhang, Yi, Xiaohong Chen, and Daejun Park (2018) \textit{Formal specification of constant product (xy=k) market maker model and implementation}. 2018.

\bibitem{BS73} Black, Fischer, Scholes, Myron (1973). \textit{The Pricing of Options and Corporate Liabilities}. Journal of Political Economy. 81 (3): 637–654. 

\bibitem{Merton73} Merton, Robert (1973). \textit{Theory of Rational Option Pricing}. Bell Journal of Economics and Management Science. 4 (1): 141–183.

%@article{angeris2019analysis,
%  title={An analysis of Uniswap markets},
%  author={Angeris, Guillermo and Kao, Hsien-Tang and Chiang, Rei and Noyes, %Charlie and Chitra, Tarun},
%  journal={arXiv preprint arXiv:1911.03380},
%  year={2019}


\end{thebibliography}

\end{document}